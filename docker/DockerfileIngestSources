# Stage 1: Build dependencies in Amazon Linux environment
FROM amazonlinux:2023 AS builder

# Install Python 3.11 and build tools
RUN yum -y groupinstall "Development Tools" && \
    yum -y install python3.11 python3.11-pip python3.11-devel gcc gcc-c++ make cmake

WORKDIR /build

# Copy and install Python dependencies into isolated folder
COPY requirements.txt .
RUN python3.11 -m pip install --no-cache-dir wheel
RUN python3.11 -m pip install --no-cache-dir --only-binary=:all: --target=python -r requirements.txt

# Stage 2: AWS Lambda runtime
FROM public.ecr.aws/lambda/python:3.11

WORKDIR /var/task

# Copy app code and installed dependencies
COPY ingest_sources.py .
COPY --from=builder /build/python /var/task/

# Define the Lambda handler
CMD ["ingest_sources.lambda_handler"]